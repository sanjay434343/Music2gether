<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Together</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* Custom styles for the modal */
        #search-modal {
            display: none; /* Hidden by default */
        }

        .result-card {
            transition: background-color 0.3s ease;
        }
        .result-card:hover {
            background-color: #e2e8f0; /* Light gray on hover */
        }
        /* Loading spinner */
        #loading {
            display: none; /* Hidden by default */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="container mx-auto px-4 md:px-0 text-center py-10">
        <h1 class="text-3xl md:text-4xl font-bold mb-6">Music Together üé∂</h1>

        <!-- Search icon to open modal -->
        <button id="open-search-modal" class="text-3xl bg-transparent border-none cursor-pointer">üîç</button>

        <!-- Video player container -->
        <div id="player" class="mt-6 w-full max-w-lg mx-auto" style="height: 390px;"></div> <!-- Set height here -->

        <!-- Playback controls -->
        <div class="mt-4 flex justify-center space-x-4">
            <button id="play" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Play</button>
            <button id="pause" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Pause</button>
            <button id="sync" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Sync</button>
        </div>

        <!-- Synchronized lyrics or chat -->
        <div id="sync-text" class="mt-4 text-lg"></div>
        <div id="loading" class="mt-4">Loading video, please wait...</div>
    </div>

    <!-- Search Modal -->
    <div id="search-modal" class="fixed inset-0 flex justify-center items-center z-50 bg-black bg-opacity-50">
        <div class="bg-white rounded-lg shadow-lg w-11/12 max-w-md p-6">
            <span class="close text-gray-600 cursor-pointer float-right text-2xl">&times;</span>
            <input type="text" id="search-bar" class="w-full border border-gray-300 p-2 rounded mt-4" placeholder="Search for a song or video...">
            <button id="search-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mt-2">Search</button>

            <div class="results mt-4 overflow-y-auto max-h-60" id="results"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.7/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.7/firebase-database.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script> <!-- Ensure this is included -->
    <script>
        // Firebase config (replace with your Firebase details)
        var firebaseConfig = {
            apiKey: "AIzaSyC-nKyC-hpcOj1e0IKMh9E8VqOKvkKr3L4",
            authDomain: "chatzi-96d60.firebaseapp.com",
            databaseURL: "https://chatzi-96d60-default-rtdb.firebaseio.com",
            projectId: "chatzi-96d60",
            storageBucket: "chatzi-96d60.appspot.com",
            messagingSenderId: "8860860390",
            appId: "1:8860860390:android:9583a63e784a116e3c6027"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        var database = firebase.database();
        
        // YouTube Iframe API setup
        var player;
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '390',
                width: '640',
                videoId: '', // Placeholder for dynamic video
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }
        
        // Sync playback with Firebase
        function syncPlayback(action, videoId = '', timestamp = null) {
            database.ref('playback').set({
                action: action,
                videoId: videoId,
                timestamp: timestamp !== null ? timestamp : (player ? player.getCurrentTime() : 0), // Check player existence
                time: Date.now()
            });
        }
    
        // Respond to Firebase playback data
        database.ref('playback').on('value', function(snapshot) {
            const data = snapshot.val();
            if (data && player) { // Check if data exists and player is defined
                if (data.action === 'play') {
                    player.loadVideoById(data.videoId); // Load new video
                    player.seekTo(data.timestamp); // Seek to the correct timestamp
                    player.playVideo();
                } else if (data.action === 'pause') {
                    if (player && typeof player.pauseVideo === 'function') { // Check if pauseVideo is a function
                        player.pauseVideo();
                    }
                } else if (data.action === 'seek') {
                    if (player && typeof player.seekTo === 'function') { // Check if seekTo is a function
                        player.seekTo(data.timestamp);
                    }
                }
            }
        });
        
        function onPlayerReady(event) {
            const playButton = document.getElementById('play');
            const pauseButton = document.getElementById('pause');
            const syncButton = document.getElementById('sync');
        
            playButton.addEventListener('click', function() {
                const videoId = player.getVideoData().video_id; // Get the current video ID
                if (videoId) { // Check if there is a video loaded
                    document.getElementById('loading').style.display = 'block'; // Show loading indicator
                    const currentTime = player.getCurrentTime(); // Get current time
                    syncPlayback('play', videoId, currentTime); // Pass the videoId and currentTime to syncPlayback
                }
            });
        
            pauseButton.addEventListener('click', function() {
                if (player && typeof player.pauseVideo === 'function') { // Ensure player is initialized
                    const currentTime = player.getCurrentTime(); // Get current time
                    syncPlayback('pause', '', currentTime); // Send current time when pausing
                }
            });
        
            syncButton.addEventListener('click', function() {
                if (player && typeof player.seekTo === 'function') { // Ensure player is initialized
                    syncPlayback('seek', player.getVideoData().video_id, player.getCurrentTime());
                }
            });
        }
        
        
        function onPlayerStateChange(event) {
            // Hide loading indicator when the video starts playing
            if (event.data === YT.PlayerState.PLAYING) {
                document.getElementById('loading').style.display = 'none'; // Hide loading
            } else if (event.data === YT.PlayerState.PAUSED) {
                syncPlayback('pause'); // Ensure pause is synced
            } else if (event.data === YT.PlayerState.BUFFERING) {
                document.getElementById('loading').style.display = 'block'; // Show loading during buffering
            }
        }
    </script>
    
</body>
</html>
